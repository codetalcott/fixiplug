<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Anthropic Adapter - Tests</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 2em; max-width: 1200px; }
    h1 { color: #333; }
    .test { margin: 1em 0; padding: 1em; border-left: 4px solid #ccc; background: #f9f9f9; }
    .test.pass { border-color: #28a745; background: #d4edda; }
    .test.fail { border-color: #dc3545; background: #f8d7da; }
    .summary { margin: 2em 0; padding: 1em; background: #e9ecef; border-radius: 4px; }
    .error { color: #721c24; font-family: monospace; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Anthropic Adapter - Tests</h1>
  <div id="results"></div>
  <div id="summary" class="summary"></div>

  <script type="module">
    import { FixiPlugAgent } from '../../sdk/agent-client.js';
    import { AnthropicAdapter } from '../../sdk/adapters/anthropic-adapter.js';
    import { createFixiplug } from '../../builder/fixiplug-factory.js';
    import introspectionPlugin from '../../plugins/introspection.js';
    import stateTrackerPlugin from '../../plugins/state-tracker.js';

    const results = document.getElementById('results');
    const summaryEl = document.getElementById('summary');
    let passed = 0, failed = 0;

    function test(name, fn) {
      const testEl = document.createElement('div');
      testEl.className = 'test';
      const title = document.createElement('strong');
      title.textContent = name;
      testEl.appendChild(title);
      results.appendChild(testEl);

      return Promise.resolve().then(fn)
        .then(() => { testEl.classList.add('pass'); testEl.innerHTML += ' ✓'; passed++; })
        .catch(error => {
          testEl.classList.add('fail');
          const errorEl = document.createElement('div');
          errorEl.className = 'error';
          errorEl.textContent = error.stack || error.message;
          testEl.appendChild(errorEl);
          failed++;
        });
    }

    function assert(condition, message) {
      if (!condition) throw new Error(message || 'Assertion failed');
    }

    const fixiplug = createFixiplug({ features: ['logging'] });
    fixiplug.use(introspectionPlugin);
    fixiplug.use(stateTrackerPlugin);

    (async () => {
      await test('Constructor requires agent', () => {
        let error;
        try { new AnthropicAdapter(null); } catch (e) { error = e; }
        assert(error && error.message.includes('requires a FixiPlugAgent instance'));
      });

      await test('Constructor accepts valid agent', () => {
        const agent = new FixiPlugAgent(fixiplug);
        const adapter = new AnthropicAdapter(agent);
        assert(adapter.agent === agent);
        assert(adapter.options.includeCoreTools === true);
      });

      await test('getToolDefinitions() returns tools', async () => {
        const agent = new FixiPlugAgent(fixiplug);
        const adapter = new AnthropicAdapter(agent);
        const tools = await adapter.getToolDefinitions();
        assert(Array.isArray(tools) && tools.length >= 5);
        const discoverTool = tools.find(t => t.name === 'discover_capabilities');
        assert(discoverTool && discoverTool.description && discoverTool.input_schema);
      });

      await test('executeToolUse() - discover_capabilities', async () => {
        const agent = new FixiPlugAgent(fixiplug);
        const adapter = new AnthropicAdapter(agent);
        const result = await adapter.executeToolUse({
          id: 'toolu_123',
          type: 'tool_use',
          name: 'discover_capabilities',
          input: {}
        });
        assert(result.plugins && result.hooks && result.version);
      });

      await test('executeToolUse() - check_capability', async () => {
        const agent = new FixiPlugAgent(fixiplug);
        const adapter = new AnthropicAdapter(agent);
        const result = await adapter.executeToolUse({
          id: 'toolu_124',
          type: 'tool_use',
          name: 'check_capability',
          input: { capability: 'fixiplug-introspection' }
        });
        assert(result.available === true);
      });

      await test('executeToolUse() - get_current_state', async () => {
        const agent = new FixiPlugAgent(fixiplug);
        const adapter = new AnthropicAdapter(agent);
        const result = await adapter.executeToolUse({
          id: 'toolu_125',
          type: 'tool_use',
          name: 'get_current_state',
          input: {}
        });
        assert(result.state && typeof result.timestamp === 'number');
      });

      await test('Use history tracking', async () => {
        const agent = new FixiPlugAgent(fixiplug);
        const adapter = new AnthropicAdapter(agent);
        adapter.clearUseHistory();
        await adapter.executeToolUse({ id: 'toolu_1', type: 'tool_use', name: 'discover_capabilities', input: {} });
        await adapter.executeToolUse({ id: 'toolu_2', type: 'tool_use', name: 'get_current_state', input: {} });
        const history = adapter.getUseHistory();
        assert(history.length === 2 && history[0].success && history[1].success);
      });

      await test('createToolResult() creates correct format', () => {
        const agent = new FixiPlugAgent(fixiplug);
        const adapter = new AnthropicAdapter(agent);
        const result = { state: 'idle', timestamp: 123456 };
        const toolResult = adapter.createToolResult('toolu_abc', result);
        assert(toolResult.type === 'tool_result');
        assert(toolResult.tool_use_id === 'toolu_abc');
        assert(toolResult.content);
        const parsed = JSON.parse(toolResult.content);
        assert(parsed.state === 'idle');
      });

      summaryEl.innerHTML = `<strong>Test Results:</strong><br>Passed: ${passed}<br>Failed: ${failed}<br>Total: ${passed + failed}<br><strong>Status: ${failed === 0 ? '✅ All tests passed!' : '❌ Some tests failed'}</strong>`;
      if (failed === 0) {
        summaryEl.style.background = '#d4edda';
        summaryEl.style.borderLeft = '4px solid #28a745';
      } else {
        summaryEl.style.background = '#f8d7da';
        summaryEl.style.borderLeft = '4px solid #dc3545';
      }
    })();
  </script>
</body>
</html>
