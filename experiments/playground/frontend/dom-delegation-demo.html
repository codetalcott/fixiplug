<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOM Event Delegation Demo - FixiPlug</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .stats-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
    }

    .stat-comparison {
      background: #f0f0f0;
      color: #333;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-comparison strong {
      color: #667eea;
      font-size: 1.5rem;
    }

    .demo-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .demo-section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .table-container {
      overflow-x: auto;
    }

    .grid-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 4px;
    }

    .grid-table td {
      min-width: 80px;
      height: 60px;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .grid-table td:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .grid-table td.clicked {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .grid-table td.success {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .click-count {
      display: block;
      font-size: 0.8rem;
      opacity: 0.8;
      margin-top: 5px;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    button:active {
      transform: translateY(0);
    }

    .event-log {
      max-height: 300px;
      overflow-y: auto;
      background: #f5f5f5;
      border-radius: 6px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }

    .log-entry {
      padding: 5px;
      margin-bottom: 5px;
      border-left: 3px solid #667eea;
      padding-left: 10px;
    }

    .log-entry.success {
      border-left-color: #00f2fe;
    }

    .form-demo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .form-group label {
      font-weight: bold;
      color: #333;
    }

    .form-group input,
    .form-group select {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    #result-display {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
      min-height: 60px;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      background: #667eea;
      color: white;
      font-size: 0.8rem;
      margin-left: 10px;
    }

    /* Event counter badges */
    [id$="-count"] {
      display: inline-block;
      transition: transform 0.2s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üöÄ DOM Event Delegation Demo</h1>
      <p>FixiPlug - 96% Memory Reduction with Event Delegation</p>
    </header>

    <!-- Stats Panel -->
    <div class="stats-panel">
      <h2>üìä Delegation Statistics</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Elements Handled</div>
          <div class="stat-value" id="elementsHandled">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Listeners Attached</div>
          <div class="stat-value" id="listenersAttached">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Event Types</div>
          <div class="stat-value" id="eventTypesCount">0</div>
        </div>
        <div class="stat-comparison">
          <div class="stat-label">Memory Reduction</div>
          <strong id="memoryReduction">N/A</strong>
          <div style="margin-top: 10px; font-size: 0.9rem;">
            Traditional: <span id="traditionalCount">0</span> listeners<br>
            Delegated: <span id="delegatedCount">0</span> listeners
          </div>
        </div>
      </div>
    </div>

    <!-- Interactive Grid Demo -->
    <div class="demo-section">
      <h2>üéØ Interactive 10x10 Grid (100 Elements)</h2>
      <p style="margin-bottom: 15px; color: #666;">
        Click any cell to trigger its fx-action. Each cell fetches unique data and shows click count.
        <span class="badge">4 listeners total</span>
      </p>

      <div class="controls">
        <button onclick="resetGrid()">üîÑ Reset Grid</button>
        <button onclick="refreshStats()">üìä Refresh Stats</button>
        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
      </div>

      <div class="table-container">
        <table class="grid-table" id="gridTable">
          <!-- Generated by JavaScript -->
        </table>
      </div>
    </div>

    <!-- Form Elements Demo -->
    <div class="demo-section">
      <h2>üìù Form Elements with Delegation</h2>
      <p style="margin-bottom: 15px; color: #666;">
        Multiple form elements sharing delegated change/input listeners.
      </p>

      <div class="form-demo">
        <div class="form-group">
          <label>Select Option:</label>
          <select fx-action="/api/select" fx-target="#result-display">
            <option value="">Choose...</option>
            <option value="option1">Option 1</option>
            <option value="option2">Option 2</option>
            <option value="option3">Option 3</option>
          </select>
        </div>

        <div class="form-group">
          <label>Text Input:</label>
          <input
            type="text"
            fx-action="/api/input"
            fx-target="#result-display"
            fx-trigger="input"
            placeholder="Type something...">
        </div>

        <div class="form-group">
          <label>Range Slider:</label>
          <input
            type="range"
            min="0"
            max="100"
            value="50"
            fx-action="/api/range"
            fx-target="#result-display"
            fx-trigger="input">
        </div>

        <div class="form-group">
          <label>Checkbox:</label>
          <input
            type="checkbox"
            fx-action="/api/checkbox"
            fx-target="#result-display">
          <span style="margin-left: 10px;">Enable feature</span>
        </div>
      </div>

      <div id="result-display">
        <em style="color: #999;">Interact with form elements to see results...</em>
      </div>
    </div>

    <!-- Comprehensive Event Types Test -->
    <div class="demo-section">
      <h2>üé™ Comprehensive Event Types Test</h2>
      <p style="margin-bottom: 15px; color: #666;">
        Test delegation across all major event types. Each element uses a different event trigger.
      </p>

      <div class="controls" style="margin-bottom: 20px;">
        <button id="add-dblclick-btn" onclick="addEventType('dblclick')">‚ûï Add dblclick</button>
        <button id="add-mouseenter-btn" onclick="addEventType('mouseenter')">‚ûï Add mouseenter</button>
        <button id="add-focus-btn" onclick="addEventType('focus')">‚ûï Add focus</button>
        <button id="add-keydown-btn" onclick="addEventType('keydown')">‚ûï Add keydown</button>
        <button onclick="showEventTypes()">üìã Show Active Events</button>
      </div>

      <div class="controls" style="margin-bottom: 20px; padding: 12px; background: #fff3cd; border-radius: 6px;">
        <strong style="color: #856404; display: block; margin-bottom: 8px;">üîç Event Validation:</strong>
        <button onclick="showEventCounts()">üìä Show Event Counts</button>
        <button onclick="resetEventCounts()">üîÑ Reset Counts</button>
        <small style="display: block; margin-top: 8px; color: #856404;">
          Use these buttons to validate that events are firing correctly. Watch the console and event log for details.
        </small>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
        <!-- Click Event (default) -->
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
          <h4 style="margin: 0 0 10px 0; color: #1976d2;">
            Click Event <span id="click-count" style="font-size: 12px; background: #1976d2; color: white; padding: 2px 8px; border-radius: 10px;">0</span>
          </h4>
          <button
            fx-action="/api/event-test/click"
            fx-target="#event-results"
            style="width: 100%; padding: 12px; cursor: pointer;">
            Click Me
          </button>
          <small style="color: #666; display: block; margin-top: 5px;">fx-trigger: click (default)</small>
        </div>

        <!-- Double Click Event -->
        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
          <h4 style="margin: 0 0 10px 0; color: #7b1fa2;">
            Double Click Event <span id="dblclick-count" style="font-size: 12px; background: #7b1fa2; color: white; padding: 2px 8px; border-radius: 10px;">0</span>
          </h4>
          <button
            fx-action="/api/event-test/dblclick"
            fx-target="#event-results"
            fx-trigger="dblclick"
            style="width: 100%; padding: 12px; cursor: pointer;">
            Double Click Me
          </button>
          <small style="color: #666; display: block; margin-top: 5px;">fx-trigger: dblclick</small>
        </div>

        <!-- Mouse Enter/Leave Event -->
        <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
          <h4 style="margin: 0 0 10px 0; color: #e65100;">
            Mouse Enter Event <span id="mouseenter-count" style="font-size: 12px; background: #e65100; color: white; padding: 2px 8px; border-radius: 10px;">0</span>
          </h4>
          <div
            fx-action="/api/event-test/mouseenter"
            fx-target="#event-results"
            fx-trigger="mouseenter"
            style="width: 100%; padding: 12px; background: #ff9800; color: white; border-radius: 4px; text-align: center;">
            Hover Over Me
          </div>
          <small style="color: #666; display: block; margin-top: 5px;">fx-trigger: mouseenter</small>
        </div>

        <!-- Change Event (select) -->
        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
          <h4 style="margin: 0 0 10px 0; color: #2e7d32;">
            Change Event <span id="change-count" style="font-size: 12px; background: #2e7d32; color: white; padding: 2px 8px; border-radius: 10px;">0</span>
          </h4>
          <select
            fx-action="/api/event-test/change"
            fx-target="#event-results"
            style="width: 100%; padding: 12px;">
            <option value="">Select...</option>
            <option value="a">Option A</option>
            <option value="b">Option B</option>
            <option value="c">Option C</option>
          </select>
          <small style="color: #666; display: block; margin-top: 5px;">fx-trigger: change (default for select)</small>
        </div>

        <!-- Input Event -->
        <div style="background: #fce4ec; padding: 15px; border-radius: 8px;">
          <h4 style="margin: 0 0 10px 0; color: #c2185b;">
            Input Event <span id="input-count" style="font-size: 12px; background: #c2185b; color: white; padding: 2px 8px; border-radius: 10px;">0</span>
          </h4>
          <input
            type="text"
            fx-action="/api/event-test/input"
            fx-target="#event-results"
            fx-trigger="input"
            placeholder="Type here..."
            style="width: 100%; padding: 12px;">
          <small style="color: #666; display: block; margin-top: 5px;">fx-trigger: input</small>
        </div>

        <!-- Focus Event -->
        <div style="background: #e0f2f1; padding: 15px; border-radius: 8px;">
          <h4 style="margin: 0 0 10px 0; color: #00695c;">
            Focus Event <span id="focus-count" style="font-size: 12px; background: #00695c; color: white; padding: 2px 8px; border-radius: 10px;">0</span>
          </h4>
          <input
            type="text"
            fx-action="/api/event-test/focus"
            fx-target="#event-results"
            fx-trigger="focus"
            placeholder="Click to focus..."
            style="width: 100%; padding: 12px;">
          <small style="color: #666; display: block; margin-top: 5px;">fx-trigger: focus</small>
        </div>

        <!-- Submit Event (form) -->
        <div style="background: #e1f5fe; padding: 15px; border-radius: 8px;">
          <h4 style="margin: 0 0 10px 0; color: #01579b;">
            Submit Event <span id="submit-count" style="font-size: 12px; background: #01579b; color: white; padding: 2px 8px; border-radius: 10px;">0</span>
          </h4>
          <form
            fx-action="/api/event-test/submit"
            fx-target="#event-results"
            style="margin: 0;">
            <input type="text" name="data" placeholder="Enter text..." style="width: 100%; padding: 8px; margin-bottom: 8px;">
            <button type="submit" style="width: 100%; padding: 12px; cursor: pointer;">Submit Form</button>
          </form>
          <small style="color: #666; display: block; margin-top: 5px;">fx-trigger: submit (default for form)</small>
        </div>

        <!-- Keydown Event -->
        <div style="background: #f1f8e9; padding: 15px; border-radius: 8px;">
          <h4 style="margin: 0 0 10px 0; color: #558b2f;">
            Keydown Event <span id="keydown-count" style="font-size: 12px; background: #558b2f; color: white; padding: 2px 8px; border-radius: 10px;">0</span>
          </h4>
          <input
            type="text"
            fx-action="/api/event-test/keydown"
            fx-target="#event-results"
            fx-trigger="keydown"
            placeholder="Press any key..."
            style="width: 100%; padding: 12px;">
          <small style="color: #666; display: block; margin-top: 5px;">fx-trigger: keydown</small>
        </div>
      </div>

      <div id="event-results" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 6px; min-height: 60px;">
        <em style="color: #999;">Trigger any event above to see results...</em>
      </div>
    </div>

    <!-- Event Log -->
    <div class="demo-section">
      <h2>üìú Event Log</h2>
      <div class="event-log" id="eventLog">
        <em style="color: #999;">Events will appear here...</em>
      </div>
    </div>
  </div>

  <script type="module">
    import { createFixiplug, FEATURES } from '/builder/fixiplug-factory.js';
    import domDelegation from '/plugins/dom-delegation.js';

    // Use async IIFE to await factory
    (async () => {

    // Mock server responses
    const mockServer = {
      async fetch(url, options = {}) {
        await new Promise(resolve => setTimeout(resolve, 100)); // Simulate network delay

        const urlObj = new URL(url, window.location.origin);
        const path = urlObj.pathname;
        const params = Object.fromEntries(urlObj.searchParams);

        // Parse row/col from path like /api/cell/5/3
        const cellMatch = path.match(/\/api\/cell\/(\d+)\/(\d+)/);

        if (cellMatch) {
          const [, row, col] = cellMatch;
          return {
            ok: true,
            status: 200,
            text: async () => `<span>Cell [${row},${col}]<span class="click-count">Clicked!</span></span>`,
            json: async () => ({ row, col, clicked: true })
          };
        }

        if (path === '/api/select') {
          return {
            ok: true,
            status: 200,
            text: async () => `<div>Selected: <strong>${params.value || 'none'}</strong></div>`,
            json: async () => ({ value: params.value })
          };
        }

        if (path === '/api/input') {
          return {
            ok: true,
            status: 200,
            text: async () => `<div>Input value: <strong>${params.value || ''}</strong> (${params.value?.length || 0} chars)</div>`,
            json: async () => ({ value: params.value })
          };
        }

        if (path === '/api/range') {
          return {
            ok: true,
            status: 200,
            text: async () => `<div>Range: <strong>${params.value}</strong>%</div>`,
            json: async () => ({ value: params.value })
          };
        }

        if (path === '/api/checkbox') {
          return {
            ok: true,
            status: 200,
            text: async () => `<div>Checkbox: <strong>${params.checked === 'true' ? 'Enabled ‚úì' : 'Disabled ‚úó'}</strong></div>`,
            json: async () => ({ checked: params.checked === 'true' })
          };
        }

        // Event test endpoints
        const eventTestMatch = path.match(/\/api\/event-test\/(\w+)/);
        if (eventTestMatch) {
          const eventType = eventTestMatch[1];
          const timestamp = new Date().toLocaleTimeString();
          return {
            ok: true,
            status: 200,
            text: async () => `
              <div style="padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 4px;">
                <strong style="font-size: 16px;">${eventType.toUpperCase()} Event Triggered!</strong>
                <div style="margin-top: 8px; opacity: 0.9; font-size: 14px;">
                  Time: ${timestamp}<br>
                  ${params.value ? `Value: ${params.value}<br>` : ''}
                  ${params.data ? `Data: ${params.data}<br>` : ''}
                  Event successfully delegated ‚úì
                </div>
              </div>
            `,
            json: async () => ({ eventType, timestamp, params })
          };
        }

        return {
          ok: true,
          status: 200,
          text: async () => '<div>Response received</div>',
          json: async () => ({ success: true })
        };
      }
    };

    // Override global fetch
    window.fetch = mockServer.fetch.bind(mockServer);

    console.log('[Demo] Initializing FixiPlug with DOM delegation...');

    // Initialize FixiPlug with DOM delegation - await for readiness
    const fixiplug = await createFixiplug({
      features: [FEATURES.DOM, FEATURES.LOGGING, FEATURES.TESTING]
    });

    console.log('[Demo] FixiPlug ready - DOM feature initialized');
    fixiplug.use(domDelegation);
    console.log('[Demo] DOM delegation plugin loaded');

    // Make fixiplug available globally for console debugging
    window.fixiplug = fixiplug;

    // Initialize variables first
    let eventCounter = 0;

    // Track event type firing counts for validation
    const eventTypeCounts = {
      click: 0,
      dblclick: 0,
      mouseenter: 0,
      change: 0,
      input: 0,
      focus: 0,
      submit: 0,
      keydown: 0
    };

    // Visual feedback helper
    function flashElement(element, color = '#4caf50') {
      const originalBg = element.style.background;
      element.style.transition = 'background 0.2s';
      element.style.background = color;
      setTimeout(() => {
        element.style.background = originalBg;
      }, 200);
    }

    // Listen to fx:before for detailed event logging and validation
    document.addEventListener('fx:before', (event) => {
      const { cfg } = event.detail || {};
      if (!cfg) return;

      const trigger = cfg.trigger?.type || 'unknown';
      const action = cfg.action || 'unknown';
      const element = event.target;

      // Track event type
      if (eventTypeCounts.hasOwnProperty(trigger)) {
        eventTypeCounts[trigger]++;

        // Update inline counter badge
        const counterEl = document.getElementById(`${trigger}-count`);
        if (counterEl) {
          counterEl.textContent = eventTypeCounts[trigger];
          // Pulse animation
          counterEl.style.transform = 'scale(1.3)';
          setTimeout(() => {
            counterEl.style.transform = 'scale(1)';
          }, 200);
        }
      }

      // Visual feedback
      flashElement(element, '#4caf50');

      // Detailed logging
      const eventInfo = {
        type: trigger,
        action: action,
        method: cfg.method || 'GET',
        count: eventTypeCounts[trigger] || 1
      };

      console.log(`[Event Fired] ${trigger.toUpperCase()} #${eventInfo.count}:`, {
        action: eventInfo.action,
        method: eventInfo.method,
        element: element.tagName
      });

      logEvent(`${trigger.toUpperCase()} event #${eventInfo.count} ‚Üí ${eventInfo.action}`, 'info');
    });

    // Listen to fx:after for success feedback
    document.addEventListener('fx:after', (event) => {
      const { cfg } = event.detail || {};
      if (!cfg) return;

      const trigger = cfg.trigger?.type || 'unknown';
      flashElement(event.target, '#2196f3');
      console.log(`[Event Success] ${trigger.toUpperCase()} completed:`, cfg.action);
    });

    // Listen to fx:error for error feedback
    document.addEventListener('fx:error', (event) => {
      const { cfg, error } = event.detail || {};
      const trigger = cfg?.trigger?.type || 'unknown';
      flashElement(event.target, '#f44336');
      console.error(`[Event Error] ${trigger.toUpperCase()} failed:`, error);
      logEvent(`${trigger.toUpperCase()} error: ${error.message}`, 'error');
    });

    // Define all functions first
    // Generate 10x10 grid
    function generateGrid() {
      const table = document.getElementById('gridTable');
      table.innerHTML = '';

      for (let row = 0; row < 10; row++) {
        const tr = document.createElement('tr');
        for (let col = 0; col < 10; col++) {
          const td = document.createElement('td');
          td.setAttribute('fx-action', `/api/cell/${row}/${col}`);
          td.setAttribute('fx-swap', 'innerHTML');
          td.textContent = `[${row},${col}]`;
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }

      // Initialize fixi for all new cells
      const elements = document.querySelectorAll('[fx-action]');
      console.log(`[Grid] Found ${elements.length} elements with fx-action`);

      let initialized = 0;
      elements.forEach(el => {
        if (!el.__fixi) {
          // Dispatch the DOM CustomEvent, not the global hook
          el.dispatchEvent(new CustomEvent('fx:process', { bubbles: true }));
          initialized++;
        }
      });

      console.log(`[Grid] Initialized ${initialized} new elements`);

      // Wait for fx:init events to complete before refreshing stats
      setTimeout(() => refreshStats(), 50);
    }

    // Refresh stats display
    async function refreshStats() {
      const stats = await fixiplug.dispatch('api:getDelegationStats');
      console.log('[Stats] Delegation stats:', stats);

      document.getElementById('elementsHandled').textContent = stats.elementsHandled || 0;
      document.getElementById('listenersAttached').textContent = stats.listenersAttached || 0;
      document.getElementById('eventTypesCount').textContent = stats.eventTypes?.length || 0;
      document.getElementById('memoryReduction').textContent = stats.memoryReduction || 'N/A';
      document.getElementById('traditionalCount').textContent = stats.elementsHandled || 0;
      document.getElementById('delegatedCount').textContent = stats.listenersAttached || 0;

      console.log(`[Stats] Display updated - Elements: ${stats.elementsHandled}, Listeners: ${stats.listenersAttached}`);
      logEvent(`Stats refreshed: ${stats.elementsHandled} elements, ${stats.listenersAttached} listeners`, 'success');
    }

    // Reset grid
    window.resetGrid = function() {
      generateGrid();
      logEvent('Grid reset', 'success');
    };

    // Refresh stats
    window.refreshStats = refreshStats;

    // Add event type dynamically
    window.addEventType = async function(eventType) {
      console.log(`[Demo] Adding event type: ${eventType}`);
      const result = await fixiplug.dispatch('api:addDelegationEventType', { eventType });

      if (result && result.success) {
        logEvent(`Added event type: ${eventType}`, 'success');
        await refreshStats();

        // Disable button to show it's been added
        const btn = document.getElementById(`add-${eventType}-btn`);
        if (btn) {
          btn.disabled = true;
          btn.textContent = `‚úì ${eventType} added`;
          btn.style.opacity = '0.6';
          btn.style.cursor = 'not-allowed';
        }
      } else {
        const message = result?.message || 'Unknown error';
        logEvent(`Failed to add ${eventType}: ${message}`, 'error');
      }
    };

    // Show active event types
    window.showEventTypes = async function() {
      console.log('[Demo] Getting active event types...');
      const stats = await fixiplug.dispatch('api:getDelegationStats');

      if (stats && stats.eventTypes) {
        const eventList = stats.eventTypes.join(', ');
        logEvent(`Active event types (${stats.eventTypes.length}): ${eventList}`, 'info');
        console.log('[Demo] Active event types:', stats.eventTypes);
      } else {
        logEvent('Failed to get event types', 'error');
      }
    };

    // Show event validation counts
    window.showEventCounts = function() {
      console.log('[Validation] Event type fire counts:', eventTypeCounts);

      const counts = Object.entries(eventTypeCounts)
        .filter(([_, count]) => count > 0)
        .map(([type, count]) => `${type}: ${count}`)
        .join(', ');

      if (counts) {
        logEvent(`Event counts: ${counts}`, 'success');
      } else {
        logEvent('No events fired yet', 'info');
      }

      return eventTypeCounts;
    };

    // Reset event counts for fresh testing
    window.resetEventCounts = function() {
      Object.keys(eventTypeCounts).forEach(key => {
        eventTypeCounts[key] = 0;

        // Reset inline counter displays
        const counterEl = document.getElementById(`${key}-count`);
        if (counterEl) {
          counterEl.textContent = '0';
        }
      });
      logEvent('Event counts reset', 'success');
      console.log('[Validation] Event counts reset');
    };

    // Clear log
    window.clearLog = function() {
      document.getElementById('eventLog').innerHTML = '<em style="color: #999;">Log cleared...</em>';
      eventCounter = 0;
    };

    // Log event
    function logEvent(message, type = 'info') {
      const log = document.getElementById('eventLog');
      if (log.querySelector('em')) {
        log.innerHTML = '';
      }

      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${++eventCounter}] ${new Date().toLocaleTimeString()}: ${message}`;
      log.insertBefore(entry, log.firstChild);

      // Keep only last 50 entries
      while (log.children.length > 50) {
        log.removeChild(log.lastChild);
      }
    }

    // Now that all functions are defined, initialize the grid
    console.log('[Demo] Generating grid...');
    generateGrid();
    logEvent('Demo initialized with DOM delegation', 'success');
    logEvent('Click any cell in the grid to see delegation in action!');

    })(); // End async IIFE
  </script>
</body>
</html>
