<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FixiPlug.js Demo</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    h2 { margin-top: 1.5em; }
    button { margin: .5em; }
    .box { padding: .5em; border: 1px solid #ccc; margin: .5em 0; }
    #log, #modified, #errorLog { background: #f9f9f9; padding: .5em; min-height: 2em; }
    .active { background: #d4edda; }
  </style>
  <script type="module">
    import fixiplug from '../fixiplug.js';
    import loggerPlug from '../plugins/logger.js';
    import errorPlug from '../plugins/error-reporter.js';
    import contentModifier from '../plugins/content-modifier.js';
    import createIdiomorphSwap from '../plugins/swap-idiomorph.js';

    // Use plugins
    fixiplug.use(loggerPlug);
    fixiplug.use(errorPlug);
    fixiplug.use(contentModifier);
    fixiplug.use(createIdiomorphSwap());

    // Helper to serialize events for display
    function serializeEvent(event) {
      if (!event || typeof event !== 'object') return JSON.stringify(event);

      // Handle arrays
      if (Array.isArray(event)) {
        return JSON.stringify(event.map(item => {
          if (item instanceof Error) return item.message;
          if (item instanceof HTMLElement) return `<${item.tagName.toLowerCase()}${item.id ? '#' + item.id : ''}>`;
          if (typeof item === 'object' && item !== null) return JSON.parse(serializeEvent(item));
          return item;
        }));
      }

      const clone = {};
      for (const key in event) {
        const value = event[key];
        if (value instanceof Error) {
          clone[key] = value.message;
        } else if (value instanceof HTMLElement) {
          clone[key] = `<${value.tagName.toLowerCase()}${value.id ? '#' + value.id : ''}>`;
        } else if (Array.isArray(value)) {
          clone[key] = JSON.parse(serializeEvent(value));
        } else if (typeof value === 'object' && value !== null) {
          clone[key] = JSON.parse(serializeEvent(value));
        } else {
          clone[key] = value;
        }
      }
      return JSON.stringify(clone);
    }

    // Logging Plugin Handlers
    async function showLogs() {
      const { logs } = await fixiplug.dispatch('api:getLogs');
      const container = document.getElementById('log');
      container.innerHTML = ''; // Clear previous logs
      logs.forEach(entry => {
        const p = document.createElement('p');
        p.textContent = `[${entry.ts}] ${entry.hookName} → ${serializeEvent(entry.event)}`;
        container.appendChild(p);
      });
    }

    document.getElementById('btnLogAlpha').onclick = async () => {
      await fixiplug.dispatch('alphaEvent', { data: 'alpha' });
      showLogs();
    };
    document.getElementById('btnLogBeta').onclick = async () => {
      await fixiplug.dispatch('betaEvent', { data: 'beta' });
      showLogs();
    };
    document.getElementById('clearLog').onclick = () => {
      document.getElementById('log').innerHTML = '(log output)';
    };

    // Error Isolation Handlers
    document.getElementById('btnError').onclick = async () => {
      try {
        await fixiplug.dispatch('brokenEvent');
      } catch (e) {
        console.error('Error caught:', e);
      }

      // Wait for error queue to process asynchronously
      await new Promise(resolve => setTimeout(resolve, 10));

      // Fetch and display errors in the errorLog element
      const { errors } = await fixiplug.dispatch('api:getErrors');
      const container = document.getElementById('errorLog');
      container.innerHTML = '';
      errors.forEach(entry => {
        const p = document.createElement('p');
        const errorMsg = entry.error instanceof Error ? entry.error.message : String(entry.error);
        p.textContent = `[${entry.ts}] ${entry.plugin} @ ${entry.hookName} → ${errorMsg}`;
        container.appendChild(p);
      });
    };
    document.getElementById('clearErrors').onclick = () => {
      document.getElementById('errorLog').innerHTML = '(error output)';
    };

    // Content Modifier Handlers
    const modifiedElement = document.getElementById('modified');
    let isModified = false;

    document.getElementById('btnModify').onclick = async () => {
      if (isModified) {
        await fixiplug.dispatch('resetEvent', { target: modifiedElement });
      } else {
        await fixiplug.dispatch('modifyEvent', { target: modifiedElement });
      }
      isModified = !isModified;
    };

    document.getElementById('disableMod').onclick = () => {
      fixiplug.disable('contentModifier');
    };

    document.getElementById('enableMod').onclick = () => {
      fixiplug.enable('contentModifier');
    };

    // Hook Priority Handlers
    let priorityOrder = [];

    // Register three hooks with different priorities
    const highPriorityHandler = (event) => {
      priorityOrder.push('HIGH priority');
      return event;
    };
    const normalPriorityHandler = (event) => {
      priorityOrder.push('NORMAL priority');
      return event;
    };
    const lowPriorityHandler = (event) => {
      priorityOrder.push('LOW priority');
      return event;
    };

    // Create temporary plugin to register priority hooks
    const priorityPlugin = {
      name: 'priority-test',
      setup(ctx) {
        ctx.on('priorityTest', highPriorityHandler, fixiplug.PRIORITY.HIGH);
        ctx.on('priorityTest', normalPriorityHandler, fixiplug.PRIORITY.NORMAL);
        ctx.on('priorityTest', lowPriorityHandler, fixiplug.PRIORITY.LOW);
      }
    };
    fixiplug.use(priorityPlugin);

    document.getElementById('btnPriority').onclick = async () => {
      priorityOrder = [];
      await fixiplug.dispatch('priorityTest', { test: true });
      const container = document.getElementById('priorityLog');
      container.innerHTML = priorityOrder.map((msg, i) => `${i + 1}. ${msg}`).join('<br>');
    };

    // Data Transformer Plugin
    const dataTransformerPlugin = {
      name: 'data-transformer',
      setup(ctx) {
        ctx.on('dataTransform', (event) => {
          const { type, data } = event;

          switch (type) {
            case 'json':
              try {
                event.transformed = JSON.parse(data);
              } catch (e) {
                event.error = e.message;
              }
              break;
            case 'csv':
              try {
                const lines = data.split('\n');
                const headers = lines[0].split(',');
                event.transformed = lines.slice(1).map(line => {
                  const values = line.split(',');
                  const obj = {};
                  headers.forEach((header, i) => {
                    obj[header] = values[i];
                  });
                  return obj;
                });
              } catch (e) {
                event.error = e.message;
              }
              break;
            default:
              event.transformed = data;
          }

          return event;
        });
      }
    };
    fixiplug.use(dataTransformerPlugin);

    // Data Pipeline Handlers
    document.getElementById('btnTransformJSON').onclick = async () => {
      const result = await fixiplug.dispatch('dataTransform', {
        type: 'json',
        data: '{"name":"FixiPlug","version":"0.0.3","features":["plugins","hooks","priority"]}'
      });
      const container = document.getElementById('pipelineOutput');
      container.innerHTML = `<pre>${JSON.stringify(result.transformed, null, 2)}</pre>`;
    };

    document.getElementById('btnTransformCSV').onclick = async () => {
      const result = await fixiplug.dispatch('dataTransform', {
        type: 'csv',
        data: 'name,version,type\nFixiPlug,0.0.3,library\nIdiomorph,0.7.4,dependency'
      });
      const container = document.getElementById('pipelineOutput');
      container.innerHTML = `<pre>${JSON.stringify(result.transformed, null, 2)}</pre>`;
    };

    // Wildcard Hook Handlers
    let wildcardEnabled = false;
    let wildcardCaptures = [];
    let wildcardHandler;

    document.getElementById('btnToggleWildcard').onclick = () => {
      if (!wildcardEnabled) {
        wildcardHandler = (event, hookName) => {
          if (hookName !== 'api:getLogs' && !hookName.startsWith('api:')) {
            wildcardCaptures.push({ hookName, event });
          }
          return event;
        };

        const wildcardPlugin = {
          name: 'wildcard-logger',
          setup(ctx) {
            ctx.on('*', wildcardHandler);
          }
        };
        fixiplug.use(wildcardPlugin);
        wildcardEnabled = true;
        document.getElementById('btnToggleWildcard').textContent = 'Disable Wildcard Logger';
      } else {
        fixiplug.unuse('wildcard-logger');
        wildcardEnabled = false;
        document.getElementById('btnToggleWildcard').textContent = 'Enable Wildcard Logger';
      }
    };

    document.getElementById('btnTestWildcard').onclick = async () => {
      wildcardCaptures = [];
      await fixiplug.dispatch('testEvent1', { id: 1 });
      await fixiplug.dispatch('testEvent2', { id: 2 });
      await fixiplug.dispatch('testEvent3', { id: 3 });

      const container = document.getElementById('wildcardLog');
      if (wildcardCaptures.length > 0) {
        container.innerHTML = wildcardCaptures.map(cap =>
          `<div>${cap.hookName} → ${serializeEvent(cap.event)}</div>`
        ).join('');
      } else {
        container.innerHTML = '(wildcard logger is disabled - enable it first!)';
      }
    };

    // Plugin Management Handlers
    let customPluginAdded = false;

    function updatePluginList() {
      const plugins = fixiplug.getPlugins();
      document.getElementById('pluginList').innerHTML =
        `Active plugins: ${plugins.join(', ') || '(none)'}`;
    }
    updatePluginList();

    document.getElementById('btnAddPlugin').onclick = () => {
      if (!customPluginAdded) {
        const customPlugin = {
          name: 'custom-demo-plugin',
          setup(ctx) {
            ctx.on('customEvent', (event) => {
              console.log('Custom plugin triggered!', event);
              return event;
            });
          }
        };
        fixiplug.use(customPlugin);
        customPluginAdded = true;
        updatePluginList();
      } else {
        alert('Custom plugin already added!');
      }
    };

    document.getElementById('btnRemovePlugin').onclick = () => {
      if (customPluginAdded) {
        fixiplug.unuse('custom-demo-plugin');
        customPluginAdded = false;
        updatePluginList();
      } else {
        alert('No custom plugin to remove!');
      }
    };

    document.getElementById('btnSwapPlugin').onclick = () => {
      const newLogger = {
        name: 'simple-console-logger',
        setup(ctx) {
          ctx.on('*', (event, hookName) => {
            console.log(`[SWAPPED LOGGER] ${hookName}:`, event);
            return event;
          });
        }
      };
      fixiplug.swap('loggerPlug', newLogger);
      updatePluginList();
      alert('Logger plugin swapped! Check console for new log format.');
    };

    // Idiomorph Swap Handlers
    const videoElement = document.getElementById('videoDemo');
    const contentContainer = document.getElementById('contentContainer');
    let isTitleAbove = true;

    document.getElementById('btnUpdateContent').onclick = async () => {
      const currentTime = videoElement.currentTime; // Save video playback position
      const videoTitle = document.getElementById('videoTitle');
      const videoContainer = document.getElementById('videoContainer');

      // Toggle the position of the video title
      if (isTitleAbove) {
        videoContainer.appendChild(videoTitle); // Move title below the video
      } else {
        videoContainer.insertBefore(videoTitle, videoContainer.firstChild); // Move title above the video
      }
      isTitleAbove = !isTitleAbove;

      // Update content dynamically
      const newContent = `
        <p>New content loaded dynamically!</p>
        <p>Video playback should resume from <strong>${currentTime.toFixed(2)} seconds</strong>.</p>
      `;
      await fixiplug.dispatch('fx:after', {
        detail: {
          target: contentContainer,
          content: newContent
        }
      });
    };
  </script>
</head>
<body>
  <h1>fixiplug.js Demo</h1>

  <h2>1. Idiomorph Swap Plugin</h2>
  <p>
    This section demonstrates the <code>swap-idiomorph</code> plugin, which preserves the state of elements like video playback during DOM updates.
  </p>
  <div id="videoContainer" class="box">
    <h3 id="videoTitle">Big Buck Bunny</h3>
    <video id="videoDemo" controls width="400">
      <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>
  <button id="btnUpdateContent">Update Content</button>
  <div id="contentContainer" class="box">
    <p>Original content. Click the button above to update this content dynamically.</p>
  </div>

  <h2>2. Logging Plugin</h2>
  <p>The logger plugin is attached using <code>fixiplug.use(fixiplugLogger)</code>. It listens to all hooks dynamically and logs their execution details.</p>
  <button id="btnLogAlpha" data-hook="alphaEvent">Trigger <code>alphaEvent</code></button>
  <button id="btnLogBeta" data-hook="betaEvent">Trigger <code>betaEvent</code></button>
  <button id="clearLog">Clear Log</button>
  <div id="log" class="box">(log output)</div>

  <h2>3. Content Modifier + Runtime Toggle</h2>
  <p>
    This section demonstrates the <code>contentModifier</code> plugin, which dynamically modifies the content and style of the box below when the <code>modifyEvent</code> is triggered. 
    You can enable or disable the plugin at runtime using the buttons provided.
  </p>
  <button id="btnModify">Trigger <code>modifyEvent</code></button>
  <div id="modified" class="box">hello world</div>
  <button id="disableMod">Disable Modifier</button>
  <button id="enableMod">Enable Modifier</button>

  <h2>4. Error Isolation</h2>
  <p>Demonstrates catching errors from a broken plugin via <code>pluginError</code> events.</p>
  <button id="btnError">Trigger <code>brokenEvent</code></button>
  <button id="clearErrors">Clear Errors</button>
  <div id="errorLog" class="box">(error output)</div>

  <h2>5. Hook Priority</h2>
  <p>Demonstrates hook execution order based on priority (HIGH > NORMAL > LOW).</p>
  <button id="btnPriority">Trigger Priority Test</button>
  <div id="priorityLog" class="box">(priority execution order)</div>

  <h2>6. Data Pipeline</h2>
  <p>Transform data through the pipeline without DOM manipulation.</p>
  <button id="btnTransformJSON">Transform JSON</button>
  <button id="btnTransformCSV">Transform CSV</button>
  <div id="pipelineOutput" class="box">(data output)</div>

  <h2>7. Wildcard Hook Listener</h2>
  <p>The <code>*</code> wildcard hook captures all events. Toggle to see it in action.</p>
  <button id="btnToggleWildcard">Enable Wildcard Logger</button>
  <button id="btnTestWildcard">Trigger Any Event</button>
  <div id="wildcardLog" class="box">(wildcard captures)</div>

  <h2>8. Plugin Management</h2>
  <p>Dynamically add, remove, and swap plugins at runtime.</p>
  <button id="btnAddPlugin">Add Custom Plugin</button>
  <button id="btnRemovePlugin">Remove Custom Plugin</button>
  <button id="btnSwapPlugin">Swap Logger Plugin</button>
  <div id="pluginList" class="box">(active plugins)</div>
</body>
</html>